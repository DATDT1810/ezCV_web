<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>ezCV - Tạo CV chuyên nghiệp trong tầm tay</title>
    <link rel="icon" href="img/core-img/favicon.ico">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body class="ali-bg">
    <!-- ##### Blog Area Start ##### -->
    <section class="blog-area">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 col-md-5">
                    <div class="cv-prev">
                        <div class="blog_thumbnail">
                            <img src="img/demos/demo-1.png" class="temp-img" alt="">
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-7">
                    <div class="cv-download">
                        <div class="row align-items-center">
                            <div class="col-lg-6 col-md-12">
                                <p class="topnote">
                                    Điền tất cả các trường bắt buộc và nhấp vào "Tạo CV" để lưu dữ liệu của bạn.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="container">
                        <!-- Form có ID rõ ràng -->
                        <form id="cvDataForm">
                            <div class="mt-150">
                                <h2>Thông tin cá nhân</h2>
                                <div class="block-container">
                                    <div class="row align-items-center">
                                        <div class="col-lg-2 col-md-4">
                                            <img src="img/test-img/1.jpg" class="d-block" alt="">
                                        </div>
                                        <div class="col-lg-5 col-md-8 mt-s">
                                            <h6>Tải ảnh của bạn</h6>
                                            <p class="text-muted mb-0">Kích thước đề xuất: 300x300 (.jpg hoặc .png)</p>
                                        </div>
                                        <div class="col-lg-5 col-md-12 mt-s">
                                            <label for="avatar">Tải ảnh lên</label>
                                            <input type="file" id="avatar" name="avatar" accept="image/*"
                                                class="form-control">
                                        </div>
                                    </div>

                                    <div class="mt-30">
                                        <div class="row">
                                            <div class="col-lg-6">
                                                <label>Tên đầy đủ:</label>
                                                <input type="text" name="full-name" class="form-control"
                                                    placeholder="Nhập tên đầy đủ của bạn" required>
                                            </div>

                                            <div class="col-lg-6">
                                                <label>Tiêu đề công việc:</label>
                                                <input type="text" name="job-title" class="form-control"
                                                    placeholder="Ex: Lập trình viên Web">
                                            </div>

                                            <div class="col-lg-6">
                                                <label>Địa chỉ:</label>
                                                <input type="text" name="address" class="form-control"
                                                    placeholder="Nhập địa chỉ của bạn" required>
                                            </div>

                                            <div class="col-lg-6">
                                                <label>Email:</label>
                                                <input type="email" name="email" class="form-control"
                                                    placeholder="Nhập email của bạn" required>
                                            </div>
                                            <div class="col-lg-6">
                                                <label>Ngày tháng năm sinh:</label>
                                                <input type="date" name="birthday" class="form-control"
                                                    placeholder="Nhập email của bạn">
                                            </div>

                                            <div class="col-lg-6">
                                                <label>Số điện thoại:</label>
                                                <input type="tel" name="phone" class="form-control"
                                                    placeholder="VD: 0901234567" pattern="^(0|\+84)(\d{9})$" required>
                                            </div>

                                            <div class="col-lg-12">
                                                <label>Giới thiệu bản thân (Bio):</label>
                                                <textarea name="comments" rows="4" class="form-control"
                                                    placeholder="Viết ngắn gọn về bản thân..."></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- HỌC VẤN -->
                            <div class="form-group add-social mt-s">
                                <h2>Học vấn</h2>
                                <div class="block-container">
                                    <div class="all-edus">
                                        <div class="new-edu">
                                            <label>Tên trường / Trung tâm:</label>
                                            <input type="text" class="form-control"
                                                placeholder="Ví dụ: Đại học Kinh tế TP.HCM">
                                            <label>Ngành học:</label>
                                            <input type="text" class="form-control"
                                                placeholder="Ví dụ: Quản trị Kinh doanh">
                                            <label>Thời gian học:</label>
                                            <input type="text" class="form-control" placeholder="Ví dụ: 2019 - 2023">
                                        </div>
                                    </div>

                                    <!-- Nút thêm -->
                                    <div class="add-blk add-edu btn btn-info mt-50" id="add-edu">
                                        <i class="fa fa-plus"></i>
                                        <span>Thêm học vấn khác</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KINH NGHIỆM LÀM VIỆC -->
                            <div class="form-group add-social mt-s">
                                <h2>Kinh nghiệm làm việc</h2>
                                <div class="block-container">
                                    <div class="all-exps">
                                        <div class="new-exp">
                                            <label>Tên công ty:</label>
                                            <input type="text" class="form-control" required
                                                placeholder="Ví dụ: Công ty TNHH ABC">
                                            <label>Vị trí:</label>
                                            <input type="text" class="form-control" required
                                                placeholder="Ví dụ: Nhân viên kinh doanh">
                                            <label>Thời gian làm việc:</label>
                                            <input type="text" class="form-control" placeholder="Ví dụ: 2022 - 2024"
                                                required>
                                        </div>
                                    </div>

                                    <!-- Nút thêm -->
                                    <div class="add-blk add-exp btn btn-info mt-50" id="add-exp">
                                        <i class="fa fa-plus"></i>
                                        <span>Thêm kinh nghiệm khác</span>
                                    </div>
                                </div>
                            </div>

                            <!-- KỸ NĂNG -->
                            <div class="form-group add-social mt-s">
                                <h2>Kỹ năng</h2>
                                <div class="block-container">
                                    <div class="all-skills">
                                        <div class="new-skills">
                                            <label>Kỹ năng:</label>
                                            <input type="text" name="skills[]" class="form-control"
                                                placeholder="VD: HTML, C#, Photoshop..." required>
                                            <label>Trình độ:</label>
                                            <input type="text" name="skills[]" class="form-control"
                                                placeholder="VD: Cơ bản, Trung bình, Thành thạo..." required>
                                        </div>
                                    </div>

                                    <!-- Nút thêm -->
                                    <div class="add-blk add-skills btn btn-info mt-50">
                                        <i class="fa fa-plus"></i>
                                        <span>Thêm kỹ năng khác</span>
                                    </div>
                                </div>
                            </div>

                            <!-- SỞ THÍCH -->
                            <div class="form-group add-social mt-s">
                                <h2>Sở thích</h2>
                                <div class="block-container">
                                    <div class="all-hoppies">
                                        <div class="new-hoppies">
                                            <label>Sở thích:</label>
                                            <input type="text" class="form-control"
                                                placeholder="Ví dụ: Đọc sách, Du lịch">
                                        </div>
                                    </div>

                                    <!-- Nút thêm -->
                                    <div class="add-blk add-hoppies btn btn-info mt-50">
                                        <i class="fa fa-plus"></i>
                                        <span>Thêm sở thích khác</span>
                                    </div>
                                </div>
                            </div>

                            <hr class="mt-100">
                            <input type="button" name="submit" value="Tạo CV" class="btn-sub">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ########## All JS ########## -->
    <!-- jQuery js -->
    <script src="js/jquery.min.js"></script>
    <!-- Popper js -->
    <script src="js/popper.min.js"></script>
    <!-- Bootstrap js -->
    <script src="js/bootstrap.min.js"></script>
    <!-- All Plugins js -->
    <script src="js/plugins.js"></script>
    <!-- Parallax js -->
    <script src="js/dzsparallaxer.js"></script>
    <!-- Active js -->
    <script src="js/form-script.js"></script>
    <script src="js/script.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <script>
        // =========================
        // Cấu hình Firebase
        // =========================
        const firebaseConfig = {
            apiKey: "AIzaSyBiG0G0uzpu4rKWyzVWWxM2y9iGGUn7e0",
            authDomain: "ezcv-60898.firebaseapp.com",
            projectId: "ezcv-60898",
            storageBucket: "ezcv-60898.appspot.com",
            messagingSenderId: "633226888127",
            appId: "1:633226888127:web:bcf0b63f51df7f1d57d70a",
            measurementId: "G-YJ62Z7GTSK"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Lấy các elements cần thiết
        const form = document.getElementById('cvDataForm');
        const submitButton = form.querySelector('.btn-sub');
        const avatarInput = document.getElementById('avatar');
        const avatarPreview = document.getElementById('avatar-preview');

        // =========================
        // Xem trước ảnh đại diện
        // =========================
        avatarInput?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                if (avatarPreview) {
                    avatarPreview.innerHTML = `
                    <img src="${evt.target.result}" alt="Preview" 
                        style="max-width:150px; border-radius:8px; margin-top:10px;">
                 `;
                }
            };
            reader.readAsDataURL(file);
        });

        // =========================
        // Xử lý click nút Tạo CV (Sử dụng 'type="button"' để loại bỏ lỗi reload)
        // =========================
        submitButton.addEventListener('click', async () => {

            // 1. KIỂM TRA TÍNH HỢP LỆ CỦA FORM (các trường required)
            // Vì nút là type="button" nên ta phải gọi checkValidity() thủ công
            if (!form.checkValidity()) {
                form.reportValidity(); // Yêu cầu trình duyệt hiển thị lỗi validation
                return; // Dừng nếu form không hợp lệ
            }

            const originalValue = submitButton.value;
            submitButton.disabled = true;
            submitButton.value = 'Đang lưu dữ liệu...';

            // -------------------------
            // Lấy thông tin cá nhân
            // -------------------------
            const personalData = {
                fullName: form.querySelector('input[name="full-name"]').value.trim(),
                jobTitle: form.querySelector('input[name="job-title"]').value.trim(),
                address: form.querySelector('input[name="address"]').value.trim(),
                email: form.querySelector('input[name="email"]').value.trim(),
                birthday: form.querySelector('input[name="birthday"]').value.trim(),
                phone: form.querySelector('input[name="phone"]').value.trim(),
                bio: form.querySelector('textarea[name="comments"]').value.trim()
            };

            // -------------------------
            // Upload ảnh đại diện
            // -------------------------
            let avatarUrl = '';
            const avatarFile = avatarInput.files[0];

            if (avatarFile) {
                try {
                    // Đổi cách sử dụng upload Task để tối ưu và dễ đọc hơn
                    const avatarRef = storage.ref('avatars/' + Date.now() + '_' + avatarFile.name);
                    await avatarRef.put(avatarFile);
                    avatarUrl = await avatarRef.getDownloadURL();
                } catch (uploadErr) {
                    console.error("Lỗi upload ảnh:", uploadErr);
                    alert("Upload ảnh thất bại. Vui lòng thử lại.");
                    submitButton.disabled = false;
                    submitButton.value = originalValue;
                    return;
                }
            }

            // -------------------------
            // Hàm thu thập block lặp (chỉ lưu block KHÔNG RỖNG)
            // -------------------------
            const collectFields = (containerSelector, selectors) => {
                const blocks = document.querySelectorAll(containerSelector);
                const result = [];
                blocks.forEach(block => {
                    const inputs = block.querySelectorAll('input, textarea');
                    const obj = {};

                    // Thu thập giá trị theo thứ tự input trong block
                    selectors.forEach((key, i) => {
                        obj[key] = inputs[i]?.value?.trim() || '';
                    });

                    // CHỈ THÊM BLOCK NẾU CÓ ÍT NHẤT 1 TRƯỜNG KHÔNG RỖNG
                    if (Object.values(obj).some(val => val !== '')) {
                        result.push(obj);
                    }
                });
                return result;
            };

            const education = collectFields('.new-edu', ['school', 'subject', 'time']);
            const experience = collectFields('.new-exp', ['company', 'title', 'time']);
            const skills = collectFields('.new-skills', ['skillName', 'level']);
            const hobbies = collectFields('.new-hoppies', ['hobbyName']);

            // -------------------------
            // Gom toàn bộ dữ liệu
            // -------------------------
            const finalData = {
                ...personalData,
                avatarUrl,
                education,
                experience,
                skills,
                hobbies,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // -------------------------
            // Gửi dữ liệu lên Firestore
            // -------------------------
            try {
                await db.collection('userCVData').add(finalData);

                // Xử lý hoàn tất thành công
                setTimeout(() => {
                    alert('Gửi dữ liệu thành công!');
                    form.reset();
                    if (avatarPreview) avatarPreview.innerHTML = '';
                    window.location.href = "index.html";
                }, 10);

            } catch (err) {
                console.error("Lỗi Firestore:", err);
                alert('Lưu thất bại, vui lòng thử lại.');
            } finally {
                submitButton.disabled = false;
                submitButton.value = originalValue;
            }
        });
    </script>

</body>

</html>